<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Graffiti Like Button</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <script type="importmap">
            {
                "imports": {
                    "vue": "https://cdn.jsdelivr.net/npm/vue/dist/vue.esm-browser.prod.js",
                    "@graffiti-garden/wrapper-vue": "https://cdn.jsdelivr.net/npm/@graffiti-garden/wrapper-vue/dist/browser/plugin.mjs",
                    "@graffiti-garden/implementation-decentralized": "https://cdn.jsdelivr.net/npm/@graffiti-garden/implementation-decentralized/dist/browser/index.js"
                }
            }
        </script>
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.classless.min.css"
        />
    </head>
    <body>
        <div id="app">
            <header>
                <h1>Graffiti Like Button</h1>
                <p>
                    <a download href
                        >Download the source code and make it your own!</a
                    >
                </p>
            </header>

            <main>
                <h2>Some things to like:</h2>
                <ul>
                    <li>
                        <a href="https://www.wikipedia.org">Wikipedia</a>
                        <graffiti-like
                            target="https://www.wikipedia.org"
                        ></graffiti-like>
                    </li>
                    <li>
                        The book
                        <a
                            href="https://en.wikipedia.org/wiki/Race_After_Technology"
                        >
                            Race After Technology
                        </a>
                        <graffiti-like
                            target="urn:isbn:9781509526390"
                        ></graffiti-like>
                    </li>
                    <li>
                        The movie
                        <a href="https://en.wikipedia.org/wiki/The_Matrix">
                            The Matrix
                        </a>
                        <graffiti-like
                            target="urn:imdb:tt0133093"
                        ></graffiti-like>
                    </li>
                    <li v-if="$graffitiSession.value">
                        Yourself!
                        <graffiti-like
                            :target="$graffitiSession.value.actor"
                        ></graffiti-like>
                    </li>
                </ul>
                <button
                    v-if="$graffitiSession.value"
                    @click="$graffiti.logout($graffitiSession.value)"
                >
                    Log Out
                </button>
            </main>
        </div>
        <template id="like-template">
            <graffiti-discover
                v-slot="{ objects: likes, isFirstPoll }"
                :channels="[target]"
                :schema="{
                    properties: {
                        value: {
                            required: ['activity', 'target'],
                            properties: {
                                activity: { enum: ['Like'] },
                                target: { enum: [target] },
                            }
                        },
                    }
                }"
            >
                <button v-if="isFirstPoll" disabled>Loading...</button>
                <button
                    v-else-if="!$graffitiSession.value"
                    @click="$graffiti.login()"
                >
                    Log in to like ({{ likes.length }})
                </button>
                <button v-else-if="processing" disabled>
                    Loading... ({{ likes.length}})
                </button>
                <button
                    v-else-if="!likes.some(l => l.actor === $graffitiSession.value.actor)"
                    @click="processing=true; $graffiti.post({
                        value: {
                            activity: 'Like',
                            target: target,
                        },
                        channels: [target]
                    }, $graffitiSession.value).finally(()=> { processing=false })"
                >
                    Like ({{ likes.length }})
                </button>
                <button
                    v-else
                    :disabled="processing"
                    @click="processing=true; likes.filter(
                        like => like.actor === $graffitiSession.value.actor
                    ).map(like => $graffiti.delete(like, $graffitiSession.value).finally(()=> {
                        processing = false
                    }))"
                >
                    Unlike ({{ likes.length }})
                </button>
            </graffiti-discover>
        </template>
        <script type="module">
            import { createApp } from "vue";
            import { GraffitiPlugin } from "@graffiti-garden/wrapper-vue";
            import { GraffitiDecentralized } from "@graffiti-garden/implementation-decentralized";

            createApp({
                components: {
                    GraffitiLike: {
                        template: "#like-template",
                        props: ["target"],
                        data() {
                            return { processing: false };
                        },
                    },
                },
            })
                .use(GraffitiPlugin, {
                    graffiti: new GraffitiDecentralized(),
                })
                .mount("#app");
        </script>
    </body>
</html>
